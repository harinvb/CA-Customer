# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

pool:
  vmImage: ubuntu-latest

steps:
  - task: InstallSSHKey@0
    inputs:
      knownHostsEntry: |
        |1|oGNQOReOMx5sOj2szw/EDMO6t3k=|6h/eXeu5sRvWvKFvNNTBijeQPqU= ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==
        |1|W8rwlvrV4dg2cE8xRvVmn6jEkQ8=|2KkIlykWAD/my6LpdrphVkCJerw= ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==
        |1|3+Xv/8uM9nLq5F5n/9lG4E1/Um0=|T+xCQZDdORb5vxjEOZ4Sw2AmH24= ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==
        |1|Gcysi1y4lo9OsQ8ZHuBvKP+fvAo=|3+0qt3L3x34X+lBJsewScnLdcXc= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBGtviDDE6SBNlJnnQcvZIR2d92j+Cz2hqdNCm70vWoltmezSLAVo/5zfTAR+PyFT0dknMifbIWU+EVzeZnm/C4Y=
        |1|kPwgj8BLGg9XMfF98IaaWtDVv5Y=|xyPNmbDnU/vLefQm08P2No9ALko= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBGtviDDE6SBNlJnnQcvZIR2d92j+Cz2hqdNCm70vWoltmezSLAVo/5zfTAR+PyFT0dknMifbIWU+EVzeZnm/C4Y=
        |1|lakO+D1MhI43I6vWUcxbzbLsFHM=|u21Nrzth37fHiyjz4owJQ+LsGEY= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBGtviDDE6SBNlJnnQcvZIR2d92j+Cz2hqdNCm70vWoltmezSLAVo/5zfTAR+PyFT0dknMifbIWU+EVzeZnm/C4Y=
        |1|FppmivaKsccF+USUb+bQMtjWetk=|yBIEmdOV/j4vpjcliFtJdcsZBq8= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBF/nBqyqHKFlo5HhFsDHnLlpp9RXm04gpoXXyF3sJVjF9fiD4qllDWYuDc5CGiqrXdK4De5txwFVyoK4A7AW1ko=
        |1|P/DDXM7OZP/ByRXQKZpHIwqWUYs=|bWOu2NvQK2TLFaOk7crTMkWTtDQ= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBF/nBqyqHKFlo5HhFsDHnLlpp9RXm04gpoXXyF3sJVjF9fiD4qllDWYuDc5CGiqrXdK4De5txwFVyoK4A7AW1ko=
        |1|1GE3/yNvgWLnT5RRJzzxtD5lpHk=|cfZZcp2fsblxyo4LcJMGfZJzOo0= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBDVjaHu5ZCQSUff7SbMi2xvbyx/A08i6T4R+Lj3jkbEkUDjM+Jn+qJUcaOynt/K3SCH+9WOptOZNFROaYVglSIw=
        |1|MTQzGCb9KZKqoznO/knA1MmI5dE=|xeNkVuj2beibx+3Y4t8eBqqyzXw= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBI2gkycrz0q3jf9B37bPnnqoqB9SRGOKio7o/G3WyPZ4GaNoyjzhRrGIb8YMmA82+SMLRlnpWzDJ3w8M8HnkLGQ=
        |1|ySyYVfY5nVUL2YCVJ0cU9xWdSwE=|HDLk+69ysRuuxaZJx0nQPdNDDAw= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBI2gkycrz0q3jf9B37bPnnqoqB9SRGOKio7o/G3WyPZ4GaNoyjzhRrGIb8YMmA82+SMLRlnpWzDJ3w8M8HnkLGQ=
        |1|WJhQwavwkLeBoCC4WzuOwVeBcXU=|hMZLlLnVJt31wmZEQ+YWFSy3PfE= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBK9ciZbX1uMWWrvYGUb4zqNAJZUj5qCUr7vpWCf4qTtl3OUnhzjmByRfLMpEcNpKia/DNmGQFjLtl1gKaKnSWuE=
        |1|/QhS6nZ2ad0L6dwb3X53rTn1HNg=|JwR+hgDVEkC1aHR7fIeI/f88FTo= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBGtviDDE6SBNlJnnQcvZIR2d92j+Cz2hqdNCm70vWoltmezSLAVo/5zfTAR+PyFT0dknMifbIWU+EVzeZnm/C4Y=
        |1|5Fq3+gDsCzSKtkaj7/oprhZJja4=|J5+IHNHBNJhurYW9E6W4bibDbKw= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBDf1/1Kx8z9GENVxqPB5wGc75J/6ZFsGKrqrxooGH1sKz4nmjsX5yFze1jYZr/3i4v3xSUuefksdGmyucPe51Lg=
      sshPublicKey: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDQe55Cuo73CvLPmQ7Tt8V9Wm/vAHoxRfWE8r8Jcn9DUbvPX6097isGUc0m7rBqKVL8usVGTlvaAHgCvqFZ27Oyzvu+ww5fW45dUuR4uRB0XTF6TBMfu0hDdzl19hmCJ4o0+C/6ukFvRFKMkro/1/SM2RhTUPSJShqNrsG3QJZATj4EcL5j64D5XrtYj9hkY11VizwdNFJp4/aQ3FBbLh2zyLzuUJnS/4L3aFTzDDTzpbf6UBUiZ8+Nosswv+X0ENT3HkeeAnw8qmx/H60jOCf3dS7U5LEj+jbD8bzqEUSukfi2ri4OMtjrdwFjl7qmxyiWQCQkSe/HX0zhluZKWqQHPOq+fuzR0TMzH2fPCnA9jrGUkUXtPiCJixzhhwksP74vFXCUH0cgBarlBXm7f3hEOjZyCLg1xwFMptdcHGHtl0As6wt6xwwBR5VJOOpmg9nADn3QEam4D+933hqXEHbrruO2N9SYO0VKF9j+sL044fV23osqPYqsi/MC5MCCmwE= hari@Inspiron-7573'
      sshKeySecureFile: 'id_rsa'
  # - task: SonarCloudPrepare@1
  #   inputs:
  #     SonarCloud: 'sonarCloud'
  #     organization: 'devops-mindtree-hari'
  #     scannerMode: 'Other'
  # - task: Maven@3
  #   inputs:
  #     mavenPomFile: 'pom.xml'
  #     goals: 'package'
  #     options: '--settings .mvn/MavenSecrets/settings.xml'
  #     publishJUnitResults: true
  #     testResultsFiles: '**/surefire-reports/TEST-*.xml'
  #     testRunTitle: 'Junit'
  #     codeCoverageToolOption: 'JaCoCo'
  #     codeCoverageRestoreOriginalPomXml: true
  #     javaHomeOption: 'JDKVersion'
  #     mavenVersionOption: 'Default'
  #     mavenAuthenticateFeed: false
  #     effectivePomSkip: false
  #     sonarQubeRunAnalysis: true
  #     sqMavenPluginVersionChoice: 'latest'
  #     pmdRunAnalysis: true
  
  # - task: Maven@3
  #   inputs:
  #     mavenPomFile: 'pom.xml'
  #     goals: 'deploy'
  #     options: '--settings .mvn/MavenSecrets/settings.xml'
  #     publishJUnitResults: false
  #     javaHomeOption: 'JDKVersion'
  #     mavenVersionOption: 'Default'
  #     mavenAuthenticateFeed: false
  #     effectivePomSkip: false
  #     sonarQubeRunAnalysis: false
  - task: TerraformTaskV2@2
    inputs:
      provider: 'azurerm'
      command: 'init'
      workingDirectory: '$(System.DefaultWorkingDirectory)/Terraform'
      backendServiceArm: 'TerraformRM'
      backendAzureRmResourceGroupName: 'cloud-shell-storage-centralindia'
      backendAzureRmStorageAccountName: 'csg100320015f749fb9'
      backendAzureRmContainerName: 'terraform'
      backendAzureRmKey: 'CA_Assignment_Ansible_Managed_Node_State'
  - task: TerraformTaskV2@2
    inputs:
      provider: 'azurerm'
      command: 'apply'
      workingDirectory: '$(System.DefaultWorkingDirectory)/Terraform'
      environmentServiceNameAzureRM: 'TerraformRM'
  - task: Bash@3
    inputs:
      filePath: 'Terraform/Infrastructure.sh'
  - task: Ansible@0
    inputs:
      ansibleInterface: 'agentMachine'
      playbookPathOnAgentMachine: 'Ansible/ansible_java_application.yaml'
      inventoriesAgentMachine: 'file'
      inventoryFileOnAgentMachine: 'Ansible/hosts'